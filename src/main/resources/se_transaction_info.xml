<?xml version="1.0" encoding="UTF-8" ?>

<sqls>
    <drop_se_transaction_info_partition_step1>
        alter table spark_etl.se_transaction_info_step1 drop partition (transaction_date = '${startDate}')
    </drop_se_transaction_info_partition_step1>

    <drop_se_transaction_info_partition_step2>
        alter table spark_etl.se_transaction_info_step2 drop partition (transaction_date = '${startDate}')
    </drop_se_transaction_info_partition_step2>

    <build_se_transaction_info>
        insert overwrite table spark_etl.se_transaction_info_step1 partition (transaction_date)
        select transaction.id,
               transaction.transaction_no,
               client.client_name,
               currency.currency_name,
               transaction.amount * rate.rate as amount,
               regexp_replace(regexp_replace(transaction.transaction_date, '-', ''), '-', '') as transaction_date
        from se_transaction_info transaction
            left join se_client_info client
                on transaction.client_no = client.client_no
            left join se_currency_tbl currency
                on transaction.currency = currency.currency
            left join se_currency_rate rate
                on currency.currency = rate.currency
                    and transaction.transaction_date = rate.stats_date
        where transaction_date = '${startDate}'
        order by transaction.transaction_date, client.client_no
    </build_se_transaction_info>

    <shield_se_transaction_info>
        insert overwrite table spark_etl.se_transaction_info_step2 partition (transaction_date)
        select *
        from spark_etl.se_transaction_info_step1
        where transaction_date = '${startDate}'
    </shield_se_transaction_info>
</sqls>
